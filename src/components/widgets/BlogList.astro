---
/**
 * BlogList Widget Component
 * 
 * Displays a list of blog posts supporting both internal markdown posts and external blog links.
 * Uses AstroWind's built-in Blog components for consistent styling.
 * 
 * Requirements: 4.1, 4.2, 4.3
 */
import { APP_BLOG } from 'astrowind:config';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import Button from '~/components/ui/Button.astro';
import { Icon } from 'astro-icon/components';
import { getBlogPermalink, getPermalink } from '~/utils/permalinks';
import { findLatestPosts } from '~/utils/blog';
import type { Widget, Post } from '~/types';

export interface ExternalBlogLink {
  title: string;
  url: string;
  excerpt?: string;
  publishDate?: Date | string;
  platform?: string; // e.g., 'LinkedIn', 'Medium', 'Dev.to'
  image?: string;
}

export interface Props extends Widget {
  title?: string;
  subtitle?: string;
  tagline?: string;
  count?: number;
  showInternalPosts?: boolean;
  showExternalLinks?: boolean;
  externalLinks?: ExternalBlogLink[];
  linkText?: string;
  linkUrl?: string | URL;
}

const {
  title = 'Latest Blog Posts',
  subtitle = 'Insights, tutorials, and industry perspectives',
  tagline = 'Blog',
  count = 4,
  showInternalPosts = true,
  showExternalLinks = true,
  externalLinks = [],
  linkText = 'View all posts',
  linkUrl = getBlogPermalink(),
  
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Fetch internal posts if enabled
const internalPosts: Post[] = (APP_BLOG.isEnabled && showInternalPosts) 
  ? await findLatestPosts({ count }) 
  : [];

// Format date helper
const formatDate = (date: Date | string | undefined): string => {
  if (!date) return '';
  const d = typeof date === 'string' ? new Date(date) : date;
  return d.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
};

// Get platform icon
const getPlatformIcon = (platform?: string): string => {
  switch (platform?.toLowerCase()) {
    case 'linkedin':
      return 'tabler:brand-linkedin';
    case 'medium':
      return 'tabler:brand-medium';
    case 'dev.to':
    case 'devto':
      return 'tabler:brand-devto';
    case 'hashnode':
      return 'tabler:brand-hashnode';
    default:
      return 'tabler:external-link';
  }
};
---

<WidgetWrapper id={id} isDark={isDark} containerClass={classes?.container as string} bg={bg}>
  <Headline title={title} subtitle={subtitle} tagline={tagline} classes={{ container: 'max-w-xl sm:mx-auto lg:max-w-2xl mb-8' }} />
  
  <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-2 max-w-6xl mx-auto">
    {/* Internal Blog Posts */}
    {showInternalPosts && internalPosts.map((post) => (
      <article class="flex flex-col bg-white dark:bg-slate-900 rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300">
        {post.image && (
          <a href={getPermalink(post.permalink, 'post')} class="block">
            <img 
              src={typeof post.image === 'string' ? post.image : post.image.src} 
              alt={post.title}
              class="w-full h-48 object-cover"
            />
          </a>
        )}
        <div class="p-6 flex flex-col flex-grow">
          <div class="flex items-center gap-2 text-sm text-muted dark:text-slate-400 mb-2">
            <Icon name="tabler:calendar" class="w-4 h-4" />
            <time datetime={post.publishDate.toISOString()}>
              {formatDate(post.publishDate)}
            </time>
            {post.category && (
              <>
                <span>•</span>
                <span class="text-primary dark:text-blue-400">{post.category.title}</span>
              </>
            )}
          </div>
          <h3 class="text-xl font-bold mb-2">
            <a 
              href={getPermalink(post.permalink, 'post')} 
              class="hover:text-primary dark:hover:text-blue-400 transition-colors"
            >
              {post.title}
            </a>
          </h3>
          {post.excerpt && (
            <p class="text-muted dark:text-slate-400 text-sm flex-grow line-clamp-3">
              {post.excerpt}
            </p>
          )}
          <div class="mt-4">
            <a 
              href={getPermalink(post.permalink, 'post')} 
              class="text-primary dark:text-blue-400 font-medium text-sm hover:underline inline-flex items-center gap-1"
            >
              Read more
              <Icon name="tabler:arrow-right" class="w-4 h-4" />
            </a>
          </div>
        </div>
      </article>
    ))}
    
    {/* External Blog Links */}
    {showExternalLinks && externalLinks.map((link) => (
      <article class="flex flex-col bg-white dark:bg-slate-900 rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border-l-4 border-primary">
        {link.image && (
          <a href={link.url} target="_blank" rel="noopener noreferrer" class="block">
            <img 
              src={link.image} 
              alt={link.title}
              class="w-full h-48 object-cover"
            />
          </a>
        )}
        <div class="p-6 flex flex-col flex-grow">
          <div class="flex items-center gap-2 text-sm text-muted dark:text-slate-400 mb-2">
            {link.platform && (
              <>
                <Icon name={getPlatformIcon(link.platform)} class="w-4 h-4" />
                <span>{link.platform}</span>
                <span>•</span>
              </>
            )}
            {link.publishDate && (
              <>
                <Icon name="tabler:calendar" class="w-4 h-4" />
                <time datetime={typeof link.publishDate === 'string' ? link.publishDate : link.publishDate.toISOString()}>
                  {formatDate(link.publishDate)}
                </time>
              </>
            )}
          </div>
          <h3 class="text-xl font-bold mb-2">
            <a 
              href={link.url} 
              target="_blank" 
              rel="noopener noreferrer"
              class="hover:text-primary dark:hover:text-blue-400 transition-colors inline-flex items-center gap-2"
            >
              {link.title}
              <Icon name="tabler:external-link" class="w-4 h-4 flex-shrink-0" />
            </a>
          </h3>
          {link.excerpt && (
            <p class="text-muted dark:text-slate-400 text-sm flex-grow line-clamp-3">
              {link.excerpt}
            </p>
          )}
          <div class="mt-4">
            <a 
              href={link.url} 
              target="_blank" 
              rel="noopener noreferrer"
              class="text-primary dark:text-blue-400 font-medium text-sm hover:underline inline-flex items-center gap-1"
            >
              Read on {link.platform || 'external site'}
              <Icon name="tabler:external-link" class="w-4 h-4" />
            </a>
          </div>
        </div>
      </article>
    ))}
  </div>
  
  {/* View All Link */}
  {APP_BLOG.list.isEnabled && linkText && linkUrl && (
    <div class="text-center mt-8">
      <Button variant="primary" href={linkUrl}>
        {linkText}
        <Icon name="tabler:arrow-right" class="w-4 h-4 ml-2" />
      </Button>
    </div>
  )}
</WidgetWrapper>
